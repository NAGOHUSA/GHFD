<script>
    // Global variables
    let currentData = null;
    let comparisonData = null;
    let chart1 = null;
    let chart2 = null;
    let dataSource = 'real';
    let filters = {
        minProfit: 70000,
        maxProfit: 150000,
        holdDays: 180,
        minROI: 20,
        counties: ['all'],
        selectedInvestor: 'all'
    };
    
    let historicalDates = [];
    let compareMode = false;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeSliders();
        initializeCountySelect();
        initializeInvestorSelect();
        initializeDateSelector();
        
        // Load data immediately
        setTimeout(function() {
            loadHistoricalIndex();
            loadSelectedDate();
        }, 500);
    });

    function initializeSliders() {
        // Set up slider value displays
        document.getElementById('minProfit').addEventListener('input', function() {
            document.getElementById('minProfitValue').textContent = '$' + (this.value/1000).toFixed(0) + 'k';
            filters.minProfit = parseInt(this.value);
        });
        
        document.getElementById('maxProfit').addEventListener('input', function() {
            document.getElementById('maxProfitValue').textContent = '$' + (this.value/1000).toFixed(0) + 'k';
            filters.maxProfit = parseInt(this.value);
        });
        
        document.getElementById('holdDays').addEventListener('input', function() {
            document.getElementById('holdDaysValue').textContent = this.value + ' days';
            filters.holdDays = parseInt(this.value);
        });
        
        document.getElementById('minROI').addEventListener('input', function() {
            document.getElementById('minROIValue').textContent = this.value + '%';
            filters.minROI = parseInt(this.value);
        });
        
        // Initialize compare mode toggle
        document.getElementById('compareMode').addEventListener('change', function() {
            compareMode = this.checked;
            const comparisonSection = document.getElementById('comparisonSection');
            const comparisonStats = document.getElementById('comparisonStats');
            
            if (compareMode) {
                comparisonSection.classList.remove('d-none');
                comparisonStats.classList.remove('d-none');
                populateComparisonDates();
            } else {
                comparisonSection.classList.add('d-none');
                comparisonStats.classList.add('d-none');
                // Load single date view
                loadSelectedDate();
            }
        });
    }

    function initializeCountySelect() {
        const select = document.getElementById('countySelect');
        const clearBtn = document.getElementById('clearCountyBtn');
        
        clearBtn.addEventListener('click', function() {
            select.value = 'all';
            filters.counties = ['all'];
            if (currentData) {
                applyFilters();
            }
        });
        
        select.addEventListener('change', function() {
            if (this.value === 'all') {
                filters.counties = ['all'];
            } else {
                filters.counties = [this.value];
            }
            if (currentData) {
                applyFilters();
            }
        });
    }

    function initializeInvestorSelect() {
        // Will be populated when data loads
    }

    function initializeDateSelector() {
        const dateSelect = document.getElementById('dateSelect');
        const compareDate1 = document.getElementById('compareDate1');
        const compareDate2 = document.getElementById('compareDate2');
        
        dateSelect.addEventListener('change', function() {
            if (!compareMode) {
                loadSelectedDate();
            }
        });
        
        compareDate1.addEventListener('change', function() {
            if (compareMode) {
                loadComparisonData();
            }
        });
        
        compareDate2.addEventListener('change', function() {
            if (compareMode) {
                loadComparisonData();
            }
        });
    }

    // üîß CRITICAL FIX: Updated data URLs to match your GitHub structure
    async function loadHistoricalIndex() {
        try {
            // Updated to match your GitHub repository structure
            const indexUrls = [
                'https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/data/results/historical_index.json',
                'https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/data/historical/historical_index.json',
                'data/historical/historical_index.json',
                'data/results/historical_index.json',
                'historical_index.json'
            ];
            
            let indexData = null;
            let loadedFrom = '';
            
            for (const url of indexUrls) {
                try {
                    console.log('Trying to load index from:', url);
                    const response = await fetch(url + '?t=' + Date.now());
                    if (response.ok) {
                        indexData = await response.json();
                        loadedFrom = url;
                        console.log('‚úÖ Loaded historical index from:', url);
                        break;
                    } else {
                        console.log('‚ùå Failed to load from:', url, 'Status:', response.status);
                    }
                } catch (e) {
                    console.log('‚ùå Network error loading from:', url, e.message);
                }
            }
            
            if (indexData) {
                historicalDates = indexData.available_dates || [];
                updateDateSelectors();
                
                // Show where data was loaded from
                document.getElementById('statusMessage').textContent = 
                    `Loaded historical data from ${loadedFrom.replace('https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/', '')}`;
                
            } else {
                console.warn('Historical index not found in any location, using demo data');
                document.getElementById('statusMessage').textContent = 
                    'Historical data not found, using demo mode';
                document.getElementById('dataSourceIndicator').className = 'data-source-indicator data-source-demo';
                generateDemoHistoricalDates();
            }
        } catch (error) {
            console.error('Error loading historical index:', error);
            generateDemoHistoricalDates();
        }
    }

    function generateDemoHistoricalDates() {
        // Generate demo dates for the last 30 days
        const today = new Date();
        historicalDates = [];
        
        for (let i = 0; i < 30; i++) {
            const date = new Date();
            date.setDate(today.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            historicalDates.push(dateStr);
        }
        
        updateDateSelectors();
        
        // Update status
        document.getElementById('statusMessage').textContent = 
            'Using demo data (real data not available)';
        document.getElementById('dataSourceIndicator').className = 'data-source-indicator data-source-demo';
    }

    function updateDateSelectors() {
        const dateSelect = document.getElementById('dateSelect');
        const compareDate1 = document.getElementById('compareDate1');
        const compareDate2 = document.getElementById('compareDate2');
        const quickDates = document.getElementById('quickDates');
        
        // Clear existing options except first
        while (dateSelect.options.length > 1) {
            dateSelect.remove(1);
        }
        while (compareDate1.options.length > 1) {
            compareDate1.remove(1);
        }
        while (compareDate2.options.length > 0) {
            compareDate2.remove(0);
        }
        quickDates.innerHTML = '';
        
        // Add dates to dropdowns
        historicalDates.forEach(date => {
            const formattedDate = formatDateForDisplay(date);
            
            // Main date selector
            const option1 = document.createElement('option');
            option1.value = date;
            option1.textContent = formattedDate;
            dateSelect.appendChild(option1);
            
            // Comparison date 1
            const option2 = document.createElement('option');
            option2.value = date;
            option2.textContent = formattedDate;
            compareDate1.appendChild(option2);
            
            // Comparison date 2
            const option3 = document.createElement('option');
            option3.value = date;
            option3.textContent = formattedDate;
            compareDate2.appendChild(option3);
        });
        
        // Add latest option to compareDate2
        const latestOption = document.createElement('option');
        latestOption.value = 'latest';
        latestOption.textContent = 'Latest Data';
        compareDate2.insertBefore(latestOption, compareDate2.firstChild);
        
        // Set default selections
        if (historicalDates.length > 0) {
            dateSelect.value = historicalDates[0];
            compareDate1.value = historicalDates[0];
            compareDate2.value = 'latest';
        }
        
        // Create quick date buttons (last 7 days)
        createQuickDateButtons();
    }

    function formatDateForDisplay(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function createQuickDateButtons() {
        const quickDates = document.getElementById('quickDates');
        const recentDates = historicalDates.slice(0, 7); // Last 7 days
        
        recentDates.forEach(date => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'date-option';
            button.textContent = new Date(date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
            button.title = formatDateForDisplay(date);
            button.dataset.date = date;
            
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.date-option').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update date selector
                document.getElementById('dateSelect').value = date;
                
                // Load the selected date
                if (!compareMode) {
                    loadSelectedDate();
                }
            });
            
            quickDates.appendChild(button);
        });
        
        // Add "Today" button
        const todayBtn = document.createElement('button');
        todayBtn.type = 'button';
        todayBtn.className = 'date-option active';
        todayBtn.textContent = 'Today';
        todayBtn.title = 'Latest Data';
        todayBtn.dataset.date = 'latest';
        
        todayBtn.addEventListener('click', function() {
            document.querySelectorAll('.date-option').forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');
            document.getElementById('dateSelect').value = 'latest';
            if (!compareMode) {
                loadSelectedDate();
            }
        });
        
        quickDates.insertBefore(todayBtn, quickDates.firstChild);
    }

    function populateComparisonDates() {
        // This function ensures comparison dropdowns are populated
        // It's already called in updateDateSelectors
    }

    // üîß CRITICAL FIX: Updated to load data directly from your GitHub repository
    async function loadSelectedDate() {
        showLoading(true);
        
        try {
            const dateSelect = document.getElementById('dateSelect');
            const selectedDate = dateSelect.value;
            
            if (selectedDate === 'latest') {
                // üî• UPDATED: Load directly from your GitHub repository
                const dataUrls = [
                    'https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/data/results/flip_summary.json', // Primary - matches your repo
                    'https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/data/results/dashboard_data.json', // Secondary
                    'https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/data/dashboard/dashboard_data.json',
                    'data/results/flip_summary.json',
                    'data/results/dashboard_data.json',
                    'data/dashboard/dashboard_data.json'
                ];
                
                let data = null;
                let loadedFrom = '';
                
                for (const url of dataUrls) {
                    try {
                        console.log('Trying to load data from:', url);
                        const response = await fetch(url + '?t=' + Date.now());
                        if (response.ok) {
                            data = await response.json();
                            loadedFrom = url;
                            console.log('‚úÖ Successfully loaded data from:', url);
                            console.log('Data structure:', Object.keys(data));
                            break;
                        } else {
                            console.log('‚ùå Failed to load from:', url, 'Status:', response.status);
                        }
                    } catch (e) {
                        console.log('‚ùå Network error loading from:', url, e.message);
                    }
                }
                
                if (data) {
                    currentData = data;
                    document.getElementById('statusAlert').className = 'alert alert-success';
                    document.getElementById('statusMessage').textContent = 
                        `Loaded latest data from ${loadedFrom.replace('https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/', '')}`;
                    document.getElementById('dataSourceIndicator').className = 'data-source-indicator data-source-live';
                    
                    // Log data structure for debugging
                    console.log('Loaded data keys:', Object.keys(currentData));
                    if (currentData.stats) {
                        console.log('Stats:', currentData.stats);
                    }
                    if (currentData.flips && Array.isArray(currentData.flips)) {
                        console.log('Number of flips:', currentData.flips.length);
                    }
                } else {
                    console.error('All data URLs failed');
                    throw new Error('Latest data not found in any location');
                }
            } else {
                // Load historical data directly from GitHub
                const historicalUrls = [
                    `https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/data/historical/dashboard_data_${selectedDate}.json`,
                    `https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/data/results/historical/dashboard_data_${selectedDate}.json`,
                    `data/historical/dashboard_data_${selectedDate}.json`
                ];
                
                let data = null;
                let loadedFrom = '';
                
                for (const url of historicalUrls) {
                    try {
                        const response = await fetch(url + '?t=' + Date.now());
                        if (response.ok) {
                            data = await response.json();
                            loadedFrom = url;
                            break;
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                if (data) {
                    currentData = data;
                    document.getElementById('statusAlert').className = 'alert alert-info';
                    document.getElementById('statusMessage').textContent = 
                        `Loaded historical data for ${formatDateForDisplay(selectedDate)} from ${loadedFrom.replace('https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/', '')}`;
                } else {
                    throw new Error('Historical data not found');
                }
            }
            
            // Initialize filters and update dashboard
            initializeFiltersFromData();
            applyFilters();
            
        } catch (error) {
            console.error('Error loading date data:', error);
            
            // Fall back to demo data
            document.getElementById('statusAlert').className = 'alert alert-warning';
            document.getElementById('statusMessage').textContent = 
                'Real data not available. Showing demo data instead. Check browser console for details.';
            document.getElementById('dataSourceIndicator').className = 'data-source-indicator data-source-demo';
            
            currentData = generateDemoData();
            console.log('Using demo data structure:', currentData);
            initializeFiltersFromData();
            applyFilters();
        } finally {
            showLoading(false);
        }
    }

    function initializeFiltersFromData() {
        if (!currentData || !currentData.stats) {
            console.warn('No stats found in currentData');
            return;
        }
        
        // Populate county select
        const countySelect = document.getElementById('countySelect');
        if (currentData.stats.counties && currentData.stats.counties.length > 0) {
            // Clear existing options except "all"
            while (countySelect.options.length > 1) {
                countySelect.remove(1);
            }
            
            // Add counties
            currentData.stats.counties.forEach(county => {
                const option = document.createElement('option');
                option.value = county;
                option.textContent = county;
                countySelect.appendChild(option);
            });
        } else {
            console.warn('No counties found in stats');
        }
        
        // Populate investor select
        const investorSelect = document.getElementById('investorSelect');
        if (currentData.stats.top_investors && currentData.stats.top_investors.length > 0) {
            // Clear existing options except "all"
            while (investorSelect.options.length > 1) {
                investorSelect.remove(1);
            }
            
            // Add investors
            currentData.stats.top_investors.forEach(investor => {
                const option = document.createElement('option');
                option.value = investor.name;
                option.textContent = investor.name;
                investorSelect.appendChild(option);
            });
        } else if (currentData.top_investors && currentData.top_investors.length > 0) {
            // Try root level top_investors
            while (investorSelect.options.length > 1) {
                investorSelect.remove(1);
            }
            
            currentData.top_investors.forEach(investor => {
                const option = document.createElement('option');
                option.value = investor.name;
                option.textContent = investor.name;
                investorSelect.appendChild(option);
            });
        } else {
            console.warn('No investors found in data');
        }
    }

    async function loadComparisonData() {
        showLoading(true);
        
        try {
            const date1 = document.getElementById('compareDate1').value;
            const date2 = document.getElementById('compareDate2').value;
            
            if (!date2) {
                throw new Error('Please select a comparison date');
            }
            
            // Load first date
            let data1, data2;
            
            if (date1 === 'latest') {
                const response = await fetch('https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/data/results/flip_summary.json?t=' + Date.now());
                data1 = response.ok ? await response.json() : generateDemoData();
            } else {
                const response = await fetch(`https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/data/historical/dashboard_data_${date1}.json?t=` + Date.now());
                data1 = response.ok ? await response.json() : generateDemoData();
            }
            
            if (date2 === 'latest') {
                const response = await fetch('https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/data/results/flip_summary.json?t=' + Date.now());
                data2 = response.ok ? await response.json() : generateDemoData();
            } else {
                const response = await fetch(`https://raw.githubusercontent.com/NAGOHUSA/GHFD/main/data/historical/dashboard_data_${date2}.json?t=` + Date.now());
                data2 = response.ok ? await response.json() : generateDemoData();
            }
            
            currentData = data1;
            comparisonData = data2;
            
            // Apply filters and update dashboard with comparison
            initializeFiltersFromData();
            applyFilters();
            updateComparisonDashboard();
            
            document.getElementById('statusAlert').className = 'alert alert-info';
            document.getElementById('statusMessage').textContent = 
                `Comparing ${formatDateForDisplay(date1)} with ${formatDateForDisplay(date2)}`;
            
        } catch (error) {
            console.error('Error loading comparison data:', error);
            alert('Error loading comparison data: ' + error.message);
            loadSelectedDate();
        } finally {
            showLoading(false);
        }
    }

    function updateComparisonDashboard() {
        if (!currentData || !comparisonData) return;
        
        // Filter both datasets
        const filteredData1 = filterData(currentData);
        const filteredData2 = filterData(comparisonData);
        
        const stats1 = filteredData1.stats;
        const stats2 = filteredData2.stats;
        
        // Calculate percentage changes
        const flipsChange = stats2.total_flips - stats1.total_flips;
        const flipsPercent = stats1.total_flips > 0 ? (flipsChange / stats1.total_flips * 100).toFixed(1) : 0;
        
        const profitChange = stats2.total_profit - stats1.total_profit;
        const profitPercent = stats1.total_profit > 0 ? (profitChange / stats1.total_profit * 100).toFixed(1) : 0;
        
        const investorsChange = stats2.total_investors - stats1.total_investors;
        const investorsPercent = stats1.total_investors > 0 ? (investorsChange / stats1.total_investors * 100).toFixed(1) : 0;
        
        const roiChange = stats2.avg_roi - stats1.avg_roi;
        const roiPercent = stats1.avg_roi > 0 ? (roiChange / stats1.avg_roi * 100).toFixed(1) : 0;
        
        // Update comparison stats
        document.getElementById('flipsComparison').textContent = 
            `${flipsChange >= 0 ? '+' : ''}${flipsPercent}%`;
        document.getElementById('flipsComparison').className = 
            flipsChange >= 0 ? 'mb-0 profit-positive' : 'mb-0 profit-high';
        document.getElementById('flipsComparisonDetails').textContent = 
            `${stats1.total_flips} vs ${stats2.total_flips}`;
        
        document.getElementById('profitComparison').textContent = 
            `${profitChange >= 0 ? '+' : ''}${profitPercent}%`;
        document.getElementById('profitComparison').className = 
            profitChange >= 0 ? 'mb-0 profit-positive' : 'mb-0 profit-high';
        document.getElementById('profitComparisonDetails').textContent = 
            `$${Math.round(stats1.total_profit).toLocaleString()} vs $${Math.round(stats2.total_profit).toLocaleString()}`;
        
        document.getElementById('investorsComparison').textContent = 
            `${investorsChange >= 0 ? '+' : ''}${investorsPercent}%`;
        document.getElementById('investorsComparison').className = 
            investorsChange >= 0 ? 'mb-0 profit-positive' : 'mb-0 profit-high';
        document.getElementById('investorsComparisonDetails').textContent = 
            `${stats1.total_investors} vs ${stats2.total_investors}`;
        
        document.getElementById('roiComparison').textContent = 
            `${roiChange >= 0 ? '+' : ''}${roiPercent}%`;
        document.getElementById('roiComparison').className = 
            roiChange >= 0 ? 'mb-0 profit-positive' : 'mb-0 profit-high';
        document.getElementById('roiComparisonDetails').textContent = 
            `${stats1.avg_roi.toFixed(1)}% vs ${stats2.avg_roi.toFixed(1)}%`;
        
        // Update main dashboard with comparison indicators
        updateDashboardWithComparison(stats1, stats2, filteredData1);
    }

    function updateDashboardWithComparison(stats1, stats2, filteredData) {
        // Update main stats with comparison indicators
        const flipsChange = stats2.total_flips - stats1.total_flips;
        const profitChange = stats2.total_profit - stats1.total_profit;
        const investorsChange = stats2.total_investors - stats1.total_investors;
        const roiChange = stats2.avg_roi - stats1.avg_roi;
        
        document.getElementById('totalFlips').textContent = stats1.total_flips.toLocaleString();
        document.getElementById('totalInvestors').textContent = stats1.total_investors.toLocaleString();
        document.getElementById('totalProfit').textContent = '$' + Math.round(stats1.total_profit).toLocaleString();
        document.getElementById('avgROI').textContent = stats1.avg_roi.toFixed(1) + '%';
        
        // Update change indicators with comparison data
        document.getElementById('flipChange').textContent = 
            `${flipsChange >= 0 ? '+' : ''}${flipsChange}`;
        document.getElementById('flipChangeContainer').innerHTML = 
            `<i class="fas fa-arrow-${flipsChange >= 0 ? 'up text-success' : 'down text-danger'}"></i> 
             <span class="${flipsChange >= 0 ? 'text-success' : 'text-danger'}">${flipsChange >= 0 ? '+' : ''}${flipsChange}</span> vs comparison`;
        
        document.getElementById('investorChange').textContent = 
            `${investorsChange >= 0 ? '+' : ''}${investorsChange}`;
        document.getElementById('investorChangeContainer').innerHTML = 
            `<i class="fas fa-arrow-${investorsChange >= 0 ? 'up text-success' : 'down text-danger'}"></i> 
             <span class="${investorsChange >= 0 ? 'text-success' : 'text-danger'}">${investorsChange >= 0 ? '+' : ''}${investorsChange}</span> investors`;
        
        document.getElementById('profitChange').textContent = 
            `$${Math.round(stats1.avg_profit || 0).toLocaleString()}`;
        document.getElementById('profitChangeContainer').innerHTML = 
            `<i class="fas fa-arrow-${profitChange >= 0 ? 'up text-success' : 'down text-danger'}"></i> 
             <span class="${profitChange >= 0 ? 'text-success' : 'text-danger'}">${profitChange >= 0 ? '+' : ''}$${Math.round(profitChange).toLocaleString()}</span> vs comparison`;
        
        document.getElementById('roiChange').textContent = 
            `${roiChange >= 0 ? '+' : ''}${roiChange.toFixed(1)}%`;
        document.getElementById('roiChangeContainer').innerHTML = 
            `<i class="fas fa-arrow-${roiChange >= 0 ? 'up text-success' : 'down text-danger'}"></i> 
             <span class="${roiChange >= 0 ? 'text-success' : 'text-danger'}">${roiChange >= 0 ? '+' : ''}${roiChange.toFixed(1)}%</span> vs comparison`;
        
        // Update flip count badge
        document.getElementById('flipCount').innerHTML = 
            `${stats1.total_flips} flips <span class="comparison-badge">${flipsChange >= 0 ? '+' : ''}${flipsChange}</span>`;
        
        // Update flips display
        updateFlipsDisplay(filteredData.flips || []);
        
        // Update investors table
        updateInvestorsTable(filteredData.top_investors || []);
        
        // Update charts
        updateCharts(filteredData);
        
        // Update last updated
        if (filteredData.stats && filteredData.stats.last_updated) {
            document.getElementById('lastUpdated').textContent = filteredData.stats.last_updated;
        } else {
            document.getElementById('lastUpdated').textContent = 'Just now';
        }
    }

    function filterData(data) {
        if (!data || !data.flips) {
            console.warn('No flips data to filter');
            return data || { flips: [], stats: {}, top_investors: [] };
        }
        
        const filtered = {
            flips: [],
            stats: JSON.parse(JSON.stringify(data.stats || {})),
            top_investors: data.top_investors || []
        };
        
        // Apply filters
        filtered.flips = data.flips.filter(flip => {
            // Profit filter
            if (flip.profit < filters.minProfit || flip.profit > filters.maxProfit) {
                return false;
            }
            
            // ROI filter
            if (flip.roi < filters.minROI) {
                return false;
            }
            
            // County filter
            if (!filters.counties.includes('all') && !filters.counties.includes(flip.county)) {
                return false;
            }
            
            // Investor filter
            if (filters.selectedInvestor !== 'all' && flip.investor !== filters.selectedInvestor) {
                return false;
            }
            
            return true;
        });
        
        // Recalculate stats
        filtered.stats.total_flips = filtered.flips.length;
        filtered.stats.total_profit = filtered.flips.reduce((sum, flip) => sum + (flip.profit || 0), 0);
        filtered.stats.avg_profit = filtered.flips.length > 0 ? filtered.stats.total_profit / filtered.flips.length : 0;
        filtered.stats.avg_roi = filtered.flips.length > 0 ? 
            filtered.flips.reduce((sum, flip) => sum + (flip.roi || 0), 0) / filtered.flips.length : 0;
        
        // Count unique investors
        const investors = new Set();
        filtered.flips.forEach(flip => {
            if (flip.investor) investors.add(flip.investor);
        });
        filtered.stats.total_investors = investors.size;
        
        return filtered;
    }

    function applyFilters() {
        if (!currentData) {
            console.warn('No currentData to filter');
            return;
        }
        
        const filteredData = filterData(currentData);
        updateDashboard(filteredData);
    }

    function resetFilters() {
        // Reset slider values
        document.getElementById('minProfit').value = 70000;
        document.getElementById('minProfitValue').textContent = '$70k';
        filters.minProfit = 70000;
        
        document.getElementById('maxProfit').value = 150000;
        document.getElementById('maxProfitValue').textContent = '$150k';
        filters.maxProfit = 150000;
        
        document.getElementById('holdDays').value = 180;
        document.getElementById('holdDaysValue').textContent = '180 days';
        filters.holdDays = 180;
        
        document.getElementById('minROI').value = 20;
        document.getElementById('minROIValue').textContent = '20%';
        filters.minROI = 20;
        
        // Reset selects
        document.getElementById('countySelect').value = 'all';
        filters.counties = ['all'];
        
        document.getElementById('investorSelect').value = 'all';
        filters.selectedInvestor = 'all';
        
        // Reapply filters
        applyFilters();
    }

    function updateDashboard(filteredData) {
        if (!filteredData) {
            console.warn('No filteredData to update dashboard');
            return;
        }
        
        const stats = filteredData.stats || {};
        
        // Update main stats
        document.getElementById('totalFlips').textContent = (stats.total_flips || 0).toLocaleString();
        document.getElementById('totalInvestors').textContent = (stats.total_investors || 0).toLocaleString();
        document.getElementById('totalProfit').textContent = '$' + Math.round(stats.total_profit || 0).toLocaleString();
        document.getElementById('avgROI').textContent = stats.avg_roi ? stats.avg_roi.toFixed(1) + '%' : '0%';
        
        // Update change indicators
        document.getElementById('flipChange').textContent = '+0';
        document.getElementById('investorChange').textContent = '+0';
        document.getElementById('profitChange').textContent = '$' + Math.round(stats.avg_profit || 0).toLocaleString();
        document.getElementById('roiChange').textContent = '+0%';
        
        // Update flip count badge
        document.getElementById('flipCount').textContent = (stats.total_flips || 0) + ' flips';
        
        // Update flips display
        updateFlipsDisplay(filteredData.flips || []);
        
        // Update investors table
        updateInvestorsTable(filteredData.top_investors || []);
        
        // Update charts
        updateCharts(filteredData);
        
        // Update last updated
        if (stats.last_updated) {
            document.getElementById('lastUpdated').textContent = stats.last_updated;
        } else {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        }
    }

    function updateFlipsDisplay(flips) {
        const container = document.getElementById('flipsContainer');
        
        if (!flips || flips.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-home fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No flips found</h5>
                    <p class="text-muted">Try adjusting your filters</p>
                </div>
            `;
            return;
        }
        
        // Show top 10 flips
        const topFlips = flips.slice(0, 10);
        
        let html = '<div class="row">';
        topFlips.forEach(flip => {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="flip-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${flip.address || 'Unknown Address'}</h6>
                                <small class="text-muted">${flip.county || 'Unknown County'}</small>
                            </div>
                            <span class="investor-badge">${flip.investor || 'Unknown Investor'}</span>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Profit</small>
                                <div class="fw-bold profit-positive">$${Math.round(flip.profit || 0).toLocaleString()}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">ROI</small>
                                <div class="fw-bold">${(flip.roi || 0).toFixed(1)}%</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Held for ${flip.hold_days || 0} days</small>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }

    function updateInvestorsTable(investors) {
        const tbody = document.getElementById('investorsBody');
        
        if (!investors || investors.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-muted">
                        <i class="fas fa-users fa-2x mb-3"></i>
                        <p>No investor data available</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        investors.forEach(investor => {
            html += `
                <tr>
                    <td class="fw-bold">${investor.name || 'Unknown'}</td>
                    <td><span class="badge bg-primary">${investor.flip_count || 0}</span></td>
                    <td class="profit-positive">$${Math.round(investor.total_profit || 0).toLocaleString()}</td>
                    <td>${(investor.avg_roi || 0).toFixed(1)}%</td>
                    <td>${Math.round(investor.avg_hold_days || 0)} days</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewInvestorDetails('${investor.name || ''}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }

    function updateCharts(filteredData) {
        // County chart
        const countyCtx = document.getElementById('countyChart').getContext('2d');
        
        if (chart1) {
            chart1.destroy();
        }
        
        // Prepare county data
        const countyCounts = {};
        (filteredData.flips || []).forEach(flip => {
            if (flip.county) {
                countyCounts[flip.county] = (countyCounts[flip.county] || 0) + 1;
            }
        });
        
        const counties = Object.keys(countyCounts);
        const counts = Object.values(countyCounts);
        
        chart1 = new Chart(countyCtx, {
            type: 'bar',
            data: {
                labels: counties,
                datasets: [{
                    label: 'Number of Flips',
                    data: counts,
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Flips'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'County'
                        }
                    }
                }
            }
        });
        
        // Profit distribution chart
        const profitCtx = document.getElementById('profitChart').getContext('2d');
        
        if (chart2) {
            chart2.destroy();
        }
        
        // Categorize profits
        const profitRanges = {
            'Under $50k': 0,
            '$50k-$100k': 0,
            '$100k-$200k': 0,
            '$200k-$500k': 0,
            'Over $500k': 0
        };
        
        (filteredData.flips || []).forEach(flip => {
            const profit = flip.profit || 0;
            if (profit < 50000) profitRanges['Under $50k']++;
            else if (profit < 100000) profitRanges['$50k-$100k']++;
            else if (profit < 200000) profitRanges['$100k-$200k']++;
            else if (profit < 500000) profitRanges['$200k-$500k']++;
            else profitRanges['Over $500k']++;
        });
        
        const profitLabels = Object.keys(profitRanges);
        const profitData = Object.values(profitRanges);
        
        chart2 = new Chart(profitCtx, {
            type: 'pie',
            data: {
                labels: profitLabels,
                datasets: [{
                    data: profitData,
                    backgroundColor: [
                        'rgba(231, 76, 60, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(155, 89, 182, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function generateDemoData() {
        const counties = ['Fulton', 'Gwinnett', 'Cobb', 'DeKalb', 'Clayton', 'Henry', 'Cherokee', 'Forsyth'];
        const investors = [
            'John Smith', 'Sarah Johnson', 'Michael Brown', 'Emily Davis', 
            'Robert Wilson', 'Jennifer Miller', 'William Taylor', 'Lisa Anderson'
        ];
        
        const flips = [];
        
        // Generate demo flips
        for (let i = 0; i < 50; i++) {
            const county = counties[Math.floor(Math.random() * counties.length)];
            const investor = investors[Math.floor(Math.random() * investors.length)];
            const profit = Math.floor(Math.random() * 300000) + 50000;
            const roi = Math.floor(Math.random() * 50) + 20;
            const holdDays = Math.floor(Math.random() * 300) + 30;
            
            flips.push({
                address: `${Math.floor(Math.random() * 9999) + 100} Main St, ${county} County`,
                county: county,
                investor: investor,
                profit: profit,
                roi: roi,
                hold_days: holdDays
            });
        }
        
        // Calculate stats
        const totalProfit = flips.reduce((sum, flip) => sum + flip.profit, 0);
        const avgProfit = totalProfit / flips.length;
        const avgROI = flips.reduce((sum, flip) => sum + flip.roi, 0) / flips.length;
        
        // Create investor summaries
        const investorMap = {};
        flips.forEach(flip => {
            if (!investorMap[flip.investor]) {
                investorMap[flip.investor] = {
                    name: flip.investor,
                    flip_count: 0,
                    total_profit: 0,
                    avg_roi: 0,
                    avg_hold_days: 0
                };
            }
            investorMap[flip.investor].flip_count++;
            investorMap[flip.investor].total_profit += flip.profit;
        });
        
        const topInvestors = Object.values(investorMap).map(inv => ({
            ...inv,
            avg_roi: Math.floor(Math.random() * 40) + 10,
            avg_hold_days: Math.floor(Math.random() * 200) + 60
        })).sort((a, b) => b.total_profit - a.total_profit);
        
        return {
            flips: flips,
            stats: {
                total_flips: flips.length,
                total_profit: totalProfit,
                avg_profit: avgProfit,
                avg_roi: avgROI,
                total_investors: Object.keys(investorMap).length,
                counties: counties,
                last_updated: new Date().toLocaleString()
            },
            top_investors: topInvestors.slice(0, 10)
        };
    }

    function setDataSource(source) {
        dataSource = source;
        
        // Update button states
        document.getElementById('realDataBtn').classList.toggle('btn-outline-light', source !== 'real');
        document.getElementById('realDataBtn').classList.toggle('btn-light', source === 'real');
        document.getElementById('demoDataBtn').classList.toggle('btn-outline-light', source !== 'demo');
        document.getElementById('demoDataBtn').classList.toggle('btn-light', source === 'demo');
        
        // Update indicator
        const indicator = document.getElementById('dataSourceIndicator');
        if (source === 'real') {
            indicator.className = 'data-source-indicator data-source-live';
            loadHistoricalIndex();
            setTimeout(loadSelectedDate, 100);
        } else {
            indicator.className = 'data-source-indicator data-source-demo';
            // For demo mode, generate demo data
            currentData = generateDemoData();
            applyFilters();
        }
    }

    function loadData() {
        if (compareMode) {
            loadComparisonData();
        } else {
            loadSelectedDate();
        }
    }

    function showLoading(show) {
        const btn = document.getElementById('refreshBtn');
        if (show) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            btn.disabled = true;
        } else {
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            btn.disabled = false;
        }
    }

    function viewInvestorDetails(investorName) {
        alert(`Viewing details for investor: ${investorName}\n\nThis feature would show detailed analytics for this investor.`);
    }

    function exportInvestors() {
        if (!currentData || !currentData.top_investors) {
            alert('No investor data to export.');
            return;
        }
        
        // Create CSV content
        let csv = 'Investor,Flips,Total Profit,Avg ROI,Avg Hold Days\n';
        currentData.top_investors.forEach(inv => {
            csv += `"${inv.name}",${inv.flip_count},${inv.total_profit},${inv.avg_roi},${inv.avg_hold_days}\n`;
        });
        
        // Create download link
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'georgia_investors_' + new Date().toISOString().split('T')[0] + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        alert('Investor list exported successfully!');
    }
</script>
